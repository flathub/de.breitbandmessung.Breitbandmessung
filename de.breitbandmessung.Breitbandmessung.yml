---
app-id: de.breitbandmessung.Breitbandmessung
runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
base: org.electronjs.Electron2.BaseApp
base-version: '22.08'
tags:
  - proprietary
command: breitbandmessung
finish-args:
  - --device=all
  - --share=ipc
  - --share=network
  - --socket=pulseaudio
  - --socket=x11
modules:
  - name: breitbandmessung
    buildsystem: simple
    build-commands:
      # install run script
      - install -Dm0755 run.bash "${FLATPAK_DEST}/bin/breitbandmessung"

      # install apply_extra script
      - install -Dm0755 apply_extra.bash "${FLATPAK_DEST}/bin/apply_extra"

      # install appstream
      - install -Dm0644 "${FLATPAK_ID}.metainfo.xml" "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml"

      # lsb-release so that Breitbandmessung thinks is running on a normal system
      - install -D lsb-release "${FLATPAK_DEST}/etc/lsb-release"

      # unpack debian package
      - bsdtar -Oxf "Breitbandmessung-linux.deb" 'data.tar.*' | bsdtar --include 'usr/share/*' -xf -

      # move shared files around
      - mv usr/share/* "${FLATPAK_DEST}/share/"
      - rm -rf usr/share
      - rm -rf usr

      # # .desktop file
      - mv "${FLATPAK_DEST}/share/applications/breitbandmessung.desktop" "${FLATPAK_DEST}/share/applications/$FLATPAK_ID.desktop"
      - desktop-file-edit --set-key=Exec --set-value=breitbandmessung "${FLATPAK_DEST}/share/applications/$FLATPAK_ID.desktop"
      - desktop-file-edit --set-key=Icon --set-value="$FLATPAK_ID" "${FLATPAK_DEST}/share/applications/$FLATPAK_ID.desktop"

      # rename icons and remove large sizes
      - find "${FLATPAK_DEST}/share/icons" -name 'breitbandmessung.*' -path '*1024*' -delete
      - find "${FLATPAK_DEST}/share/icons" -name 'breitbandmessung.*' -exec rename -v breitbandmessung "$FLATPAK_ID" {} \;
    sources:
      - type: file
        path: apply_extra.bash
      - type: file
        path: run.bash
      - type: file
        path: lsb-release
      - type: file
        path: de.breitbandmessung.Breitbandmessung.metainfo.xml
      - type: file
        dest-filename: Breitbandmessung-linux.deb
        url: 'https://download.breitbandmessung.de/bbm/Breitbandmessung-3.3.0-linux.deb'
        only-arches:
          - x86_64
        size: 68009538
        sha256: 'd7699b7719258def66b2746d364d5102d220dce0b26debffbd47abb03663da2e'
        x-checker-data:
          type: html
          url: https://download.breitbandmessung.de/bbm/
          pattern: "<a href=\"(Breitbandmessung-([\\d\\.]+\\d)-linux.deb)\">"
      - type: extra-data
        filename: Breitbandmessung-linux.deb
        url: 'https://download.breitbandmessung.de/bbm/Breitbandmessung-3.3.0-linux.deb'
        only-arches:
          - x86_64
        size: 68009538
        sha256: 'd7699b7719258def66b2746d364d5102d220dce0b26debffbd47abb03663da2e'
        x-checker-data:
          type: html
          url: https://download.breitbandmessung.de/bbm/
          pattern: "<a href=\"(Breitbandmessung-([\\d\\.]+\\d)-linux.deb)\">"
